label: Symfony Web App
type: symfony
version: "2.0"

questions:
  - id: projectName
    label: Project name
    type: string
    default: ""
    required: true

  - id: symfonyAuth
    label: Auth type
    type: select
    default: no-auth
    options:
      - label: No auth
        value: no-auth
      - label: Simple auth
        value: simple-auth

  - id: dockerize
    label: Dockerize
    type: boolean
    default: false
    trueLabel: "Yes"
    falseLabel: "No"

dependencies:
  - symfony-cli
  - composer
  - id: make
    when:
      dockerize: "true"

pipeline:
  - type: createProjectDirectory
    label: Create project directory

  - type: run
    label: Create Symfony web app
    config:
      command: symfony new --webapp .

  - type: run
    label: Install JWT authentication bundle
    when:
      symfonyAuth: simple-auth
    config:
      command: composer require lexik/jwt-authentication-bundle --no-interaction

  - type: run
    label: Install TenZero auth package
    when:
      symfonyAuth: simple-auth
    config:
      command: composer require happycode/tenzero-auth --no-scripts --no-interaction

  - type: run
    label: Generate JWT keypair
    when:
      symfonyAuth: simple-auth
    config:
      command: bin/console lexik:jwt:generate-keypair --skip-if-exists

  - type: modify
    label: Update JWT key paths
    when:
      symfonyAuth: simple-auth
    config:
      file: config/packages/lexik_jwt_authentication.yaml
      replacements:
        - search: "private_key_path: null"
          replace: "private_key_path: '{{projectName}}/config/jwt/private.pem'"
        - search: "public_key_path: null"
          replace: "public_key_path: '{{projectName}}/config/jwt/public.pem'"

  - type: modify
    label: Add JWT env variables
    when:
      symfonyAuth: simple-auth
    config:
      file: .env
      appendIfMissing:
        marker: "###> lexik/jwt-authentication-bundle ###"
        content: |-
          ###> lexik/jwt-authentication-bundle ###
          JWT_SECRET_KEY=%kernel.project_dir%/config/jwt/private.pem
          JWT_PUBLIC_KEY=%kernel.project_dir%/config/jwt/public.pem
          JWT_PASSPHRASE=
          ###< lexik/jwt-authentication-bundle ###

  - type: copy
    label: Copy auth package config
    when:
      symfonyAuth: simple-auth
    config:
      source: config/packages
      dest: config/packages

  - type: copy
    label: Copy auth source files
    when:
      symfonyAuth: simple-auth
    config:
      source: src/auth
      dest: src

  - type: copy
    label: Copy auth templates
    when:
      symfonyAuth: simple-auth
    config:
      source: templates/auth
      dest: templates

  - type: copy
    label: Copy docker auth files
    when:
      dockerize: "true"
      symfonyAuth: simple-auth
    config:
      source: docker/auth
      dest: .
      interpolate: true

  - type: copy
    label: Copy docker no-auth files
    when:
      dockerize: "true"
      symfonyAuth: no-auth
    config:
      source: docker/no-auth
      dest: .
      interpolate: true

  - type: copy
    label: Copy development Dockerfile
    when:
      dockerize: "true"
    config:
      source: docker/Dockerfile.dev
      dest: Dockerfile.dev

  - type: copy
    label: Copy docker entrypoint script
    when:
      dockerize: "true"
    config:
      source: docker/entrypoint.sh
      dest: docker/entrypoint.sh

  - type: copy
    label: Copy Makefile
    when:
      dockerize: "true"
    config:
      source: Makefile
      dest: Makefile

  - type: copy
    label: Copy shared Make targets
    when:
      dockerize: "true"
    config:
      source: Makefile.include
      dest: Makefile.include

  - type: delete
    label: Remove default Docker compose file
    when:
      dockerize: "true"
    config:
      file: compose.yaml

  - type: delete
    label: Remove Docker compose override
    when:
      dockerize: "true"
    config:
      file: compose.override.yaml

  - type: modify
    label: Comment local DATABASE_URL example
    when:
      dockerize: "true"
    config:
      file: .env
      replacements:
        - search: "DATABASE_URL="
          replace: |-
            # uncomment for local server
            # DATABASE_URL=

  - type: modify
    label: Register TenZero auth bundle
    when:
      symfonyAuth: simple-auth
    config:
      file: config/bundles.php
      replacements:
        - search: "return ["
          replace: |-
            return [
                Happycode\TenZeroAuth\TenZeroAuthBundle::class => ['all' => true],

  - type: append
    label: Add TenZero auth routes
    when:
      symfonyAuth: simple-auth
    config:
      file: config/routes.yaml
      content: |-
        tenzero_auth:
            resource: '@TenZeroAuthBundle/config/routes.php'

  - type: run
    label: Start containers
    when:
      dockerize: "true"
      symfonyAuth: simple-auth
    config:
      command: make up

  - type: run
    label: Generate migrations
    when:
      dockerize: "true"
      symfonyAuth: simple-auth
    config:
      command: make migrations

  - type: run
    label: Apply migrations
    when:
      dockerize: "true"
      symfonyAuth: simple-auth
    config:
      command: make migrate

  - type: run
    label: Seed initial admin user
    when:
      dockerize: "true"
      symfonyAuth: simple-auth
    config:
      command: make console tz:auth:adduser admin@example.com admin

  - type: run
    label: Clear cache
    when:
      dockerize: "true"
      symfonyAuth: simple-auth
    config:
      command: make cc
