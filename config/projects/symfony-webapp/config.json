{
    "label": "Symfony Web App",
    "type": "symfony",
    "version": "1.0",
    "options": {
        "projectName": {
            "label": "Project name",
            "type": "text",
            "default": ""
        },
        "symfonyAuth": {
            "label": "Auth type",
            "type": "select",
            "options": [
                { "label": "No auth", "value": "no-auth" },
                { "label": "Simple auth", "value": "simple-auth" }
            ],
            "default": "no-auth"
        },
        "dockerize": {
            "label": "Dockerize",
            "type": "select",
            "options": [
                { "label": "Yes", "value": "yes" },
                { "label": "No", "value": "no" }
            ],
            "default": "no"
        }
    },
    "pipeline": [
        {
            "type": "run",
            "config": {
                "command": "symfony new --webapp %projectName%",
                "cwd": "."
            }
        },
        {
            "type": "run",
            "config": {
                "command": "cd %projectName% && composer require lexik/jwt-authentication-bundle --no-interaction",
                "cwd": "."
            },
            "when": {
                "symfonyAuth": "simple-auth"
            }
        },
        {
            "type": "run",
            "config": {
                "command": "cd %projectName% && composer require happycode/tenzero-auth --no-scripts --no-interaction",
                "cwd": "."
            },
            "when": {
                "symfonyAuth": "simple-auth"
            }
        },
        {
            "type": "run",
            "config": {
                "command": "cd %projectName% && bin/console lexik:jwt:generate-keypair --skip-if-exists",
                "cwd": "."
            },
            "when": {
                "symfonyAuth": "simple-auth"
            }
        },
        {
            "type": "modify",
            "config": {
                "file": "%projectName%/config/packages/lexik_jwt_authentication.yaml",
                "replacements": [
                    {
                        "search": "private_key_path: null",
                        "replace": "private_key_path: '%projectName%/config/jwt/private.pem'"
                    },
                    {
                        "search": "public_key_path: null",
                        "replace": "public_key_path: '%projectName%/config/jwt/public.pem'"
                    }
                ]
            },
            "when": {
                "symfonyAuth": "simple-auth"
            }
        },
        {
            "type": "modify",
            "config": {
                "file": "%projectName%/.env",
                "appendIfMissing": {
                    "marker": "###> lexik/jwt-authentication-bundle ###",
                    "content": "###> lexik/jwt-authentication-bundle ###\nJWT_SECRET_KEY=%kernel.project_dir%/config/jwt/private.pem\nJWT_PUBLIC_KEY=%kernel.project_dir%/config/jwt/public.pem\nJWT_PASSPHRASE=\n###< lexik/jwt-authentication-bundle ###"
                }
            },
            "when": {
                "symfonyAuth": "simple-auth"
            }
        },
        {
            "type": "copy",
            "config": {
                "source": "config/packages",
                "dest": "%projectName%/config/packages",
                "when": {
                    "symfonyAuth": "simple-auth"
                }
            }
        },
        {
            "type": "copy",
            "config": {
                "source": "src/auth",
                "dest": "%projectName%/src",
                "when": {
                    "symfonyAuth": "simple-auth"
                }
            }
        },
        {
            "type": "copy",
            "config": {
                "source": "templates/auth",
                "dest": "%projectName%/templates",
                "when": {
                    "symfonyAuth": "simple-auth"
                }
            }
        },
        {
            "type": "copy",
            "config": {
                "source": "docker/auth",
                "dest": "%projectName%",
                "when": {
                    "dockerize": "yes",
                    "symfonyAuth": "simple-auth"
                },
                "interpolate": true
            }
        },
        {
            "type": "copy",
            "config": {
                "source": "docker/no-auth",
                "dest": "%projectName%",
                "when": {
                    "dockerize": "yes",
                    "symfonyAuth": "no-auth"
                },
                "interpolate": true
            }
        },
        {
            "type": "copy",
            "config": {
                "source": "docker/Dockerfile.dev",
                "dest": "%projectName%/Dockerfile.dev",
                "when": {
                    "dockerize": "yes"
                }
            }
        },
        {
            "type": "copy",
            "config": {
                "source": "docker/entrypoint.sh",
                "dest": "%projectName%/docker/entrypoint.sh",
                "when": {
                    "dockerize": "yes"
                }
            }
        },
        {
            "type": "copy",
            "config": {
                "source": "Makefile",
                "dest": "%projectName%/Makefile",
                "when": {
                    "dockerize": "yes"
                }
            }
        },
        {
            "type": "copy",
            "config": {
                "source": "Makefile.include",
                "dest": "%projectName%/Makefile.include",
                "when": {
                    "dockerize": "yes"
                }
            }
        },
        {
            "type": "delete",
            "config": {
                "file": "%projectName%/compose.yaml"
            },
            "when": {
                "dockerize": "yes"
            }
        },
        {
            "type": "delete",
            "config": {
                "file": "%projectName%/compose.override.yaml"
            },
            "when": {
                "dockerize": "yes"
            }
        },
        {
            "type": "modify",
            "config": {
                "file": "%projectName%/.env",
                "replacements": [
                    {
                        "search": "DATABASE_URL=",
                        "replace": "# uncomment for local server \n # DATABASE_URL="
                    }
                ]
            },
            "when": {
                "dockerize": "yes"
            }
        },
        {
            "type": "modify",
            "config": {
                "file": "%projectName%/config/bundles.php",
                "replacements": [
                    {
                        "search": "return [",
                        "replace": "return [\n\tHappycode\\TenZeroAuth\\TenZeroAuthBundle::class => ['all' => true],"
                    }
                ]
            },
            "when": {
                "symfonyAuth": "simple-auth"
            }
        },
        {
            "type": "append",
            "config": {
                "file": "%projectName%/config/routes.yaml",
                "content": "\ntenzero_auth:\n    resource: '@TenZeroAuthBundle/config/routes.php'\n"
            },
            "when": {
                "symfonyAuth": "simple-auth"
            }
        },
        {
            "type": "run",
            "config": {
                "command": "cd %projectName% && make up",
                "cwd": "."
            },
            "when": {
                "dockerize": "yes",
                "symfonyAuth": "simple-auth"
            }
        },
        {
            "type": "run",
            "config": {
                "command": "cd %projectName% && make migrations",
                "cwd": "."
            },
            "when": {
                "dockerize": "yes",
                "symfonyAuth": "simple-auth"
            }
        },
        {
            "type": "run",
            "config": {
                "command": "cd %projectName% && make migrate",
                "cwd": "."
            },
            "when": {
                "dockerize": "yes",
                "symfonyAuth": "simple-auth"
            }
        },
        {
            "type": "run",
            "config": {
                "command": "cd %projectName% && make cc",
                "cwd": "."
            },
            "when": {
                "dockerize": "yes",
                "symfonyAuth": "simple-auth"
            }
        }
    ]
}
